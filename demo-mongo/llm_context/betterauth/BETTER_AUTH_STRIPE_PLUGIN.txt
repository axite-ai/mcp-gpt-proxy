### Install Stripe SDK for Better Auth

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Install the official Stripe SDK on your server-side project. This SDK is a dependency for the Better Auth Stripe plugin, enabling interaction with the Stripe API from your backend.

```npm
npm install stripe@^19.1.0
```

--------------------------------

### Stripe Webhook Event Handling

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Demonstrates how to handle custom Stripe webhook events beyond the automatically handled ones.

```TypeScript
stripe({
    // ... other options
    onEvent: async (event) => {
        // Handle any Stripe event
        switch (event.type) {
            case "invoice.paid":
                // Handle paid invoice
                break;
            case "payment_intent.succeeded":
                // Handle successful payment
                break;
        }
    }
})
```

--------------------------------

### Configure Server-Side Better Auth with Stripe Plugin

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Integrate the Stripe plugin into your server-side Better Auth configuration. This setup involves importing necessary modules, initializing the Stripe client with your secret key, and configuring the plugin with your Stripe webhook secret and customer creation settings.

```typescript
import { betterAuth } from "better-auth"
import { stripe } from "@better-auth/stripe"
import Stripe from "stripe"

const stripeClient = new Stripe(process.env.STRIPE_SECRET_KEY!, {
    apiVersion: "2025-10-29.clover" // Latest API version as of Stripe SDK v19
})

export const auth = betterAuth({
    // ... your existing config
    plugins: [
        stripe({
            stripeClient,
            stripeWebhookSecret: process.env.STRIPE_WEBHOOK_SECRET!,
            createCustomerOnSignUp: true
        })
    ]
})
```

--------------------------------

### Integrate Stripe Plugin with Better Auth (Server-side)

Source: https://context7.com/better-auth/better-auth/llms.txt

This code demonstrates how to initialize the Better Auth library with the Stripe plugin on the server-side. It configures the Stripe client, defines optional callbacks for `createCustomer` to customize customer creation, and `onWebhook` to handle specific Stripe webhook events. Dependencies include `@better-auth/stripe` and `stripe`.

```typescript
// Install the Stripe package
// npm install @better-auth/stripe stripe

import { betterAuth } from "better-auth";
import { stripe } from "@better-auth/stripe";
import Stripe from "stripe";

const stripeClient = new Stripe(process.env.STRIPE_SECRET_KEY!);

export const auth = betterAuth({
  plugins: [
    stripe({
      stripe: stripeClient,

      // Optional: customize customer creation
      async createCustomer(user) {
        return {
          email: user.email,
          name: user.name,
          metadata: {
            userId: user.id,
          },
        };
      },

      // Optional: handle webhook events
      async onWebhook(event) {
        if (event.type === "customer.subscription.created") {
          const subscription = event.data.object;
          console.log("New subscription:", subscription.id);
        }
      },
    }),
  ],
});
```

--------------------------------

### POST /subscription/upgrade

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Initiates a subscription upgrade or creation process for a user, typically redirecting them to Stripe Checkout. Requires an active user session.

```APIDOC
## POST /subscription/upgrade

### Description
Upgrades or creates a user's subscription to a specified plan. This method typically initiates a Stripe Checkout session and redirects the user to complete the payment. It requires an active user session for authentication.

### Method
POST

### Endpoint
/subscription/upgrade

### Parameters
#### Path Parameters
_None_

#### Query Parameters
_None_

#### Request Body
- **plan** (string) - Required - The name of the plan to upgrade to. Default: "pro"
- **annual** (boolean) - Optional - Whether to upgrade to an annual plan. Default: `true`
- **referenceId** (string) - Optional - A reference ID for the subscription, typically the user or organization ID. Defaults to the current logged-in user ID if not provided. Example: "org_123"
- **subscriptionId** (string) - Optional - The ID of an existing subscription to upgrade or modify. **Required** if the user already has an active subscription to prevent creating multiple concurrent subscriptions.
- **metadata** (Record<string, any>) - Optional - Custom metadata to attach to the subscription.
- **seats** (number) - Optional - The number of seats to provision for the subscription (if applicable for team plans). Default: `1`
- **successUrl** (string) - Required - The callback URL to which the user will be redirected after a successful subscription payment.
- **cancelUrl** (string) - Required - The URL to which the user will be redirected if they cancel the payment process on Stripe Checkout.
- **returnUrl** (string) - Optional - A URL for customers to return to your website from the Stripe billing portal.
- **disableRedirect** (boolean) - Optional - If `true`, the API will not perform an immediate redirect after processing; typically used for client-side handling. Default: `true`

### Request Example
```json
{
  "plan": "pro",
  "successUrl": "/dashboard",
  "cancelUrl": "/pricing",
  "annual": true,
  "referenceId": "org_123",
  "seats": 5
}
```

### Response
#### Success Response (200)
This endpoint primarily facilitates a redirect to Stripe Checkout. If `disableRedirect` is `true`, it might return an object containing a Stripe Checkout Session URL or an empty success response.
- _No explicit JSON response fields are detailed for a direct success, as the primary action is a client-side redirect._

#### Response Example
```json
{}
```
```

--------------------------------

### POST /subscription/cancel

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Cancel a user's subscription. This operation typically redirects the user to the Stripe Billing Portal where they can finalize the cancellation process.

```APIDOC
## POST /subscription/cancel

### Description
Cancel a user's subscription. This operation typically redirects the user to the Stripe Billing Portal where they can finalize the cancellation process.

### Method
POST

### Endpoint
/subscription/cancel

### Parameters
#### Path Parameters
_None_

#### Query Parameters
_None_

#### Request Body
- **referenceId** (string) - Optional - Reference ID of the subscription to cancel. Defaults to the authenticated user's ID.
- **subscriptionId** (string) - Optional - The ID of the subscription to cancel.
- **returnUrl** (string) - Required - URL to redirect customers to after they complete the cancellation process in the billing portal.

### Request Example
```json
{
  "referenceId": "org_123",
  "subscriptionId": "sub_123",
  "returnUrl": "/account"
}
```

### Response
#### Success Response (200)
- **message** (string) - A confirmation message.
- **redirectUrl** (string) - The URL to the Stripe Billing Portal for cancellation.

#### Response Example
```json
{
  "message": "Redirecting to Stripe Billing Portal for cancellation.",
  "redirectUrl": "https://billing.stripe.com/p/..."
}
```
```

--------------------------------

### Use Stripe Plugin with Better Auth Client (Client-side)

Source: https://context7.com/better-auth/better-auth/llms.txt

This section illustrates various client-side operations using the Better Auth Stripe plugin. It covers retrieving or creating Stripe customers, initiating checkout sessions, managing customer portal sessions, and fetching user subscriptions. The `stripeClient()` function is used to initialize the client-side plugin.

```typescript
// Client Usage
import { stripeClient } from "@better-auth/stripe/client";

const authClient = createAuthClient({
  plugins: [stripeClient()],
});

// Get or Create Stripe Customer
const { data: customer } = await authClient.stripe.getCustomer();

console.log("Stripe customer ID:", customer.id);

// Create Checkout Session
const { data: session } = await authClient.stripe.createCheckoutSession({
  priceId: "price_1234567890",
  successUrl: "https://example.com/success",
  cancelUrl: "https://example.com/cancel",
});

// Redirect to Stripe checkout
window.location.href = session.url;

// Create Customer Portal Session
const { data: portal } = await authClient.stripe.createPortalSession({
  returnUrl: "https://example.com/account",
});

// Redirect to customer portal
window.location.href = portal.url;

// Get Customer Subscriptions
const { data: subscriptions } = await authClient.stripe.getSubscriptions();

subscriptions?.forEach(sub => {
  console.log(`Subscription: ${sub.id}, Status: ${sub.status}`);
});
```

--------------------------------

### Configure Client-Side Better Auth with Stripe Plugin

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Set up the client-side Better Auth configuration to enable Stripe-related features for your frontend application. This snippet demonstrates how to import and add the Stripe client plugin, enabling subscription management if desired.

```typescript
import { createAuthClient } from "better-auth/client"
import { stripeClient } from "@better-auth/stripe/client"

export const client = createAuthClient({
    // ... your existing config
    plugins: [
        stripeClient({
            subscription: true //if you want to enable subscription management
        })
    ]
})
```

--------------------------------

### Reference Authorization Implementation

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Implements authorization logic to control which users can manage subscriptions for specific reference IDs like organizations.

```TypeScript
subscription: {
    // ... other options
    authorizeReference: async ({ user, session, referenceId, action }) => {
        // Check if the user has permission to manage subscriptions for this reference
        if (action === "upgrade-subscription" || action === "cancel-subscription" || action === "restore-subscription") {
            const org = await db.member.findFirst({
                where: {
                    organizationId: referenceId,
                    userId: user.id
                }
            });
            return org?.role === "owner"
        }
        return true;
    }
}
```

--------------------------------

### Install Stripe Plugin

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/changelogs/1-2.mdx

Install the Stripe plugin package for Better Auth

```bash
npm install @better-auth/stripe
```

--------------------------------

### Client Subscription Management with Reference IDs

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Shows how to create and list subscriptions for organizations using custom reference IDs. Includes support for team plans with seat-based pricing.

```TypeScript
// Create a subscription for an organization
await client.subscription.upgrade({
    plan: "pro",
    referenceId: "org_123456",
    successUrl: "/dashboard",
    cancelUrl: "/pricing",
    seats: 5 // Number of seats for team plans
});

// List subscriptions for an organization
const { data: subscriptions } = await client.subscription.list({
    query: {
        referenceId: "org_123456"
    }
});
```

```TypeScript
await client.subscription.upgrade({
    plan: "team",
    referenceId: "org_123456",
    seats: 10, // 10 team members
    successUrl: "/org/billing/success",
    cancelUrl: "/org/billing"
});
```

--------------------------------

### Configure Stripe Customer Creation on Signup (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Configures the Better Auth plugin to automatically create a Stripe customer when a user signs up. It also demonstrates how to customize the customer creation parameters and handle the post-creation callback, linking the Stripe customer to the application's user.

```typescript
stripe({
    // ... other options
    createCustomerOnSignUp: true,
    onCustomerCreate: async ({ stripeCustomer, user }, ctx) => {
        // Do something with the newly created customer
        console.log(`Customer ${stripeCustomer.id} created for user ${user.id}`);
    },
    getCustomerCreateParams: async (user, ctx) => {
        // Customize the Stripe customer creation parameters
        return {
            metadata: {
                referralSource: user.metadata?.referralSource
            }
        };
    }
})
```

--------------------------------

### Define Create Billing Portal Session API Request Body (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

This type definition describes the request body for creating a Stripe billing portal session via a POST request to `/subscription/billing-portal`. It allows specifying a `locale` for the portal, an optional `referenceId`, and a `returnUrl` for redirecting users after they manage their billing, payment methods, and subscription history.

```ts
type createBillingPortal = {
    /**
    * The IETF language tag of the locale customer portal is displayed in. If blank or auto, browser's locale is used.
    */
    locale?: string
    /**
     * Reference id of the subscription to upgrade.
     */
    referenceId?: string = "123"
    /**
     * Return URL to redirect back after successful subscription.
     */
    returnUrl?: string
}
```

--------------------------------

### Create Organization Subscription with Stripe

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Shows how to upgrade an organization to a paid subscription plan using the client SDK, including annual billing options and callback URLs.

```typescript
// Get the active organization
const { data: activeOrg } = client.useActiveOrganization();

// Create a subscription for the organization
await client.subscription.upgrade({
    plan: "team",
    referenceId: activeOrg.id,
    seats: 10,
    annual: true, // upgrade to an annual plan (optional)
    successUrl: "/org/billing/success",
    cancelUrl: "/org/billing"
});
```

--------------------------------

### Upgrade Subscription with Basic Options (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Demonstrates a basic usage of the `client.subscription.upgrade` method to change a user's subscription plan. It includes setting the target plan, success and cancel URLs, and optional parameters like annual billing, reference ID, and seats.

```typescript
await client.subscription.upgrade({
    plan: "pro",
    successUrl: "/dashboard",
    cancelUrl: "/pricing",
    annual: true, // Optional: upgrade to an annual plan
    referenceId: "org_123", // Optional: defaults to the current logged in user ID
    seats: 5 // Optional: for team plans
});
```

--------------------------------

### Customize Stripe Checkout Session Parameters

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Demonstrates how to modify Stripe checkout session with promotion codes, tax collection, billing addresses, custom text, and metadata.

```typescript
getCheckoutSessionParams: async ({ user, session, plan, subscription }, ctx) => {
    return {
        params: {
            allow_promotion_codes: true,
            tax_id_collection: {
                enabled: true
            },
            billing_address_collection: "required",
            custom_text: {
                submit: {
                    message: "We'll start your subscription right away"
                }
            },
            metadata: {
                planType: "business",
                referralCode: user.metadata?.referralCode
            }
        },
        options: {
            idempotencyKey: `sub_${user.id}_${plan.name}_${Date.now()}`
        }
    };
}
```

--------------------------------

### Enable Tax ID Collection in Stripe Checkout

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Configures Stripe checkout to collect tax identification numbers from customers during subscription.

```typescript
subscription: {
    // ... other options
    getCheckoutSessionParams: async ({ user, session, plan, subscription }, ctx) => {
        return {
            params: {
                tax_id_collection: {
                    enabled: true
                }
            }
        };
    }
}
```

--------------------------------

### Define Subscription Upgrade Parameters (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Provides the TypeScript type definition for the parameters used when upgrading a user's subscription. It details properties like plan name, annual option, reference ID, subscription ID, metadata, seats, and various redirect URLs.

```typescript
type upgradeSubscription = {
    /**
     * The name of the plan to upgrade to.
     */
    plan: string = "pro"
    /**
     * Whether to upgrade to an annual plan.
     */
    annual?: boolean = true
    /**
     * Reference id of the subscription to upgrade.
     */
    referenceId?: string = "123"
    /**
     * The id of the subscription to upgrade.
     */
    subscriptionId?: string = "sub_123"
    metadata?: Record<string, any>
    /**
     * Number of seats to upgrade to (if applicable).
     */
    seats?: number = 1
    /**
     * Callback URL to redirect back after successful subscription.
     */
    successUrl: string
    /**
     * If set, checkout shows a back button and customers will be directed here if they cancel payment.
     */
    cancelUrl: string
    /**
     * URL to take customers to when they click on the billing portal’s link to return to your website.
     */
    returnUrl?: string
    /**
     * Disable redirect after successful subscription.
     */
    disableRedirect: boolean = true
}
```

--------------------------------

### POST /subscription/restore

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Restore a previously canceled subscription. This reactivates a subscription that was set to cancel at the end of the billing period, allowing it to continue renewing automatically.

```APIDOC
## POST /subscription/restore

### Description
Restore a previously canceled subscription. This reactivates a subscription that was set to cancel at the end of the billing period, allowing it to continue renewing automatically.

### Method
POST

### Endpoint
/subscription/restore

### Parameters
#### Path Parameters
_None_

#### Query Parameters
_None_

#### Request Body
- **referenceId** (string) - Optional - Reference ID of the subscription to restore. Defaults to '123'.
- **subscriptionId** (string) - Optional - The ID of the subscription to restore.

### Request Example
```json
{
  "referenceId": "org_123",
  "subscriptionId": "sub_456"
}
```

### Response
#### Success Response (200)
- **message** (string) - A confirmation message indicating the subscription was restored.

#### Response Example
```json
{
  "message": "Subscription restored successfully."
}
```
```

--------------------------------

### Retrieve and Filter Active Subscriptions (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

This code defines the type for listing active subscriptions and demonstrates how to find an active or trialing subscription from a list retrieved from the `/subscription/list` API. It also shows checking subscription-based limits like `projectLimit` from the `subscriptions` object.

```ts
type listActiveSubscriptions = {
    /**
     * Reference id of the subscription to list.
     */
    referenceId?: string = '123'
}

// get the active subscription
const activeSubscription = subscriptions.find(
    sub => sub.status === "active" || sub.status === "trialing"
);

// Check subscription limits
const projectLimit = subscriptions?.limits?.projects || 0;
```

--------------------------------

### Configure Stripe plugin (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/blogs/1-3.mdx

Registers the Stripe plugin for billing and usage features. Depends on @better-auth/stripe and typical Stripe credentials configured elsewhere. This snippet shows plugin registration; additional Stripe-specific options must be provided in production.

```typescript
import { betterAuth } from "better-auth";
import { stripe } from "@better-auth/stripe";

export const auth = betterAuth({
  plugins: [
    stripe({
      // ...
    }),
  ],
});
```

--------------------------------

### Upgrade Subscription Plan (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Use the `client.subscription.upgrade` method to switch a user's subscription to a different plan. This function ensures the user only pays for the new plan and handles the transition, requiring a plan identifier, success/cancel URLs, and the current Stripe subscription ID.

```ts
await client.subscription.upgrade({
    plan: "pro",
    successUrl: "/dashboard",
    cancelUrl: "/pricing",
    subscriptionId: "sub_123", // the Stripe subscription ID of the user's current plan
});
```

--------------------------------

### Enable Automatic Tax Calculation

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Configures automatic tax calculation based on customer location, requiring Stripe tax registration setup.

```typescript
subscription: {
    // ... other options
    getCheckoutSessionParams: async ({ user, session, plan, subscription }, ctx) => {
        return {
            params: {
                automatic_tax: {
                    enabled: true
                }
            }
        };
    }
}
```

--------------------------------

### Customize Stripe Plugin Subscription Schema in TypeScript

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

This TypeScript snippet demonstrates how to customize the database schema mapping for the Stripe plugin within an `auth.ts` configuration file. It allows renaming the `subscription` table to `stripeSubscriptions` and mapping individual fields like `plan` to `planName`, providing flexibility to align with existing database conventions.

```typescript
stripe({
    // ... other options
    schema: {
        subscription: {
            modelName: "stripeSubscriptions", // map the subscription table to stripeSubscriptions
            fields: {
                plan: "planName" // map the plan field to planName
            }
        }
    }
})
```

--------------------------------

### POST /subscription/billing-portal

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Create a Stripe customer billing portal session. This allows customers to manage their subscriptions, update payment methods, and view billing history through a secure Stripe-hosted portal.

```APIDOC
## POST /subscription/billing-portal

### Description
Create a Stripe customer billing portal session. This allows customers to manage their subscriptions, update payment methods, and view billing history through a secure Stripe-hosted portal.

### Method
POST

### Endpoint
/subscription/billing-portal

### Parameters
#### Path Parameters
_None_

#### Query Parameters
_None_

#### Request Body
- **locale** (string) - Optional - The IETF language tag of the locale for the customer portal (e.g., 'en-US'). If blank or 'auto', the browser's locale is used.
- **referenceId** (string) - Optional - Reference ID of the subscription. Defaults to '123'.
- **returnUrl** (string) - Optional - URL to redirect the user back to after they exit the billing portal.

### Request Example
```json
{
  "locale": "en-US",
  "referenceId": "org_789",
  "returnUrl": "/dashboard/settings"
}
```

### Response
#### Success Response (200)
- **data** (object) - An object containing the URL for the billing portal session.
  - **url** (string) - The URL to the Stripe customer billing portal session.

#### Response Example
```json
{
  "data": {
    "url": "https://billing.stripe.com/session/cs_test_..."
  }
}
```
```

--------------------------------

### Trial Periods Configuration

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Configures free trial periods for subscription plans with callbacks for trial start, end, and expiration events.

```TypeScript
{
    name: "pro",
    priceId: "price_0987654321",
    freeTrial: {
        days: 14,
        onTrialStart: async (subscription) => {
            // Called when a trial starts
            await sendTrialStartEmail(subscription.referenceId);
        },
        onTrialEnd: async ({ subscription }, ctx) => {
            // Called when a trial ends
            await sendTrialEndEmail(subscription.referenceId);
        },
        onTrialExpired: async (subscription, ctx) => {
            // Called when a trial expires without conversion
            await sendTrialExpiredEmail(subscription.referenceId);
        }
    }
}
```

--------------------------------

### Configure Stripe Plugin

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/changelogs/1-2.mdx

Set up Stripe integration for customer management and subscriptions with automatic customer creation on signup

```typescript
import { stripe } from "@better-auth/stripe";

export const auth = betterAuth({
  plugins: [
    stripe({
      createCustomerOnSignup: true,
      subscription: {
        enabled: true,
        plans: [
          {
            name: "pro",
            priceId: "price_1234567890",
          },
        ],
      },
    }),
  ],
});
```

--------------------------------

### Define Static and Dynamic Subscription Plans (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Illustrates how to configure subscription plans within the Better Auth plugin. It shows examples of defining static plans with fixed limits and prices, as well as dynamically fetching plans from a database or API, mapping their properties to the required format.

```typescript
// Static plans
subscription: {
    enabled: true,
    plans: [
        {
            name: "basic", // the name of the plan, it'll be automatically lower cased when stored in the database
            priceId: "price_1234567890", // the price ID from stripe
            annualDiscountPriceId: "price_1234567890", // (optional) the price ID for annual billing with a discount
            limits: {
                projects: 5,
                storage: 10
            }
        },
        {
            name: "pro",
            priceId: "price_0987654321",
            limits: {
                projects: 20,
                storage: 50
            },
            freeTrial: {
                days: 14,
            }
        }
    ]
}

// Dynamic plans (fetched from database or API)
subscription: {
    enabled: true,
    plans: async () => {
        const plans = await db.query("SELECT * FROM plans");
        return plans.map(plan => ({
            name: plan.name,
            priceId: plan.stripe_price_id,
            limits: JSON.parse(plan.limits)
        }));
    }
}
```

--------------------------------

### Subscription Lifecycle Hooks

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Implement custom logic at key subscription lifecycle events like creation, updates, cancellation, and deletion.

```TypeScript
subscription: {
    // ... other options
    onSubscriptionComplete: async ({ event, subscription, stripeSubscription, plan }) => {
        // Called when a subscription is successfully created
        await sendWelcomeEmail(subscription.referenceId, plan.name);
    },
    onSubscriptionUpdate: async ({ event, subscription }) => {
        // Called when a subscription is updated
        console.log(`Subscription ${subscription.id} updated`);
    },
    onSubscriptionCancel: async ({ event, subscription, stripeSubscription, cancellationDetails }) => {
        // Called when a subscription is canceled
        await sendCancellationEmail(subscription.referenceId);
    },
    onSubscriptionDeleted: async ({ event, subscription, stripeSubscription }) => {
        // Called when a subscription is deleted
        console.log(`Subscription ${subscription.id} deleted`);
    }
}
```

--------------------------------

### Handle Subscription Upgrade Errors (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Shows how to properly handle potential errors that may occur during a subscription upgrade operation. It demonstrates checking the `error` object returned from the `client.subscription.upgrade` method and alerting the user if an issue arises.

```typescript
const { error } = await client.subscription.upgrade({
    plan: "pro",
    successUrl: "/dashboard",
    cancelUrl: "/pricing",
});
if(error) {
    alert(error.message);
}
```

--------------------------------

### Configure Authorization for Listing Subscriptions (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

This configuration snippet for `stripe()` demonstrates how to implement `authorizeReference` within the subscription options. Specifically, it shows how to authorize a user to list subscriptions for a given `referenceId` (e.g., an organization ID) by checking user roles in a database for the 'list-subscription' action.

```ts
stripe({
    // ... other options
    subscription: {
        // ... other subscription options
        authorizeReference: async ({ user, session, referenceId, action }) => {
            if(action === "list-subscription") {
                const org = await db.member.findFirst({
                    where: {
                        organizationId: referenceId,
                        userId: user.id
                    }
                });
                return org?.role === "owner"
            }
            // Check if the user has permission to list subscriptions for this reference
            return true;
        }
    }
})
```

--------------------------------

### Handle Stripe Webhooks with Better Auth (Server-side)

Source: https://context7.com/better-auth/better-auth/llms.txt

This code snippet shows how to set up a server-side endpoint (e.g., a Next.js API route) to receive and process Stripe webhooks using Better Auth. The `auth.handler(req)` automatically verifies the webhook signature and dispatches events to the `onWebhook` handler configured in the Stripe plugin, simplifying webhook management.

```typescript
// Server-side: Handle Stripe webhooks
// app/api/stripe/webhook/route.ts
import { auth } from "@/lib/auth";

export async function POST(req: Request) {
  const signature = req.headers.get("stripe-signature");
  const body = await req.text();

  // Better Auth automatically handles webhook verification
  // and calls the onWebhook handler configured in the plugin
  return auth.handler(req);
}
```

--------------------------------

### Define Cancel Subscription API Request Body (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

This type definition outlines the parameters required to cancel a user's subscription via a POST request to `/subscription/cancel`. It includes optional `referenceId` and `subscriptionId`, and a mandatory `returnUrl` for post-cancellation redirection to the billing portal.

```ts
type cancelSubscription = {
    /**
     * Reference id of the subscription to cancel. Defaults to the userId.
     */
    referenceId?: string = 'org_123'
    /**
     * The id of the subscription to cancel.
     */
    subscriptionId?: string = 'sub_123'
    /**
     * URL to take customers to when they click on the billing portal’s link to return to your website.
     */
    returnUrl: string = '/account'
}
```

--------------------------------

### GET /subscription/list

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Retrieve a list of the user's active subscriptions. This endpoint provides details on current and trial subscriptions, including status and any associated limits.

```APIDOC
## GET /subscription/list

### Description
Retrieve a list of the user's active subscriptions. This endpoint provides details on current and trial subscriptions, including status and any associated limits.

### Method
GET

### Endpoint
/subscription/list

### Parameters
#### Path Parameters
_None_

#### Query Parameters
- **referenceId** (string) - Optional - Reference ID of the subscription to list. Defaults to '123'.

#### Request Body
_None_

### Request Example
GET /subscription/list?referenceId=org_abc

### Response
#### Success Response (200)
- **[array]** (object) - A list of subscription objects.
  - **id** (string) - The unique identifier for the subscription.
  - **status** (string) - The status of the subscription (e.g., "active", "trialing", "canceled").
  - **planId** (string) - The ID of the plan the subscription is for.
  - **limits** (object) - An object containing various limits associated with the subscription.
    - **projects** (number) - The maximum number of projects allowed for this subscription.

#### Response Example
```json
[
  {
    "id": "sub_active1",
    "status": "active",
    "planId": "plan_pro",
    "limits": {
      "projects": 5
    }
  },
  {
    "id": "sub_trialing1",
    "status": "trialing",
    "planId": "plan_basic",
    "limits": {
      "projects": 1
    }
  }
]
```
```

--------------------------------

### Authorize Organization Subscription Management

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

Implements authorization logic to verify users can manage subscriptions for organizations, checking member roles in the database.

```typescript
subscription: {
    // ... other subscription options
    authorizeReference: async ({ user, referenceId, action }) => {
        const member = await db.members.findFirst({
            where: {
                userId: user.id,
                organizationId: referenceId
            }
        });

        return member?.role === "owner" || member?.role === "admin";
    }
}
```

--------------------------------

### POST /api/attach

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/autumn.mdx

Attach a payment method or redirect to Stripe checkout for purchase

```APIDOC
## POST /api/attach

### Description
Redirects customer to Stripe checkout or opens AttachDialog for payment processing

### Method
POST

### Endpoint
/api/attach

### Parameters
#### Request Body
- **productId** (string) - Required - The product identifier to purchase
- **dialog** (component) - Optional - Dialog component for payment confirmation

### Request Example
{
  "productId": "pro",
  "dialog": "AttachDialog"
}

### Response
#### Success Response (200)
- **success** (boolean) - Confirmation of successful attachment
- **redirectUrl** (string) - URL to Stripe checkout if needed
```

--------------------------------

### Define Restore Subscription API Request Body (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

This type definition specifies the parameters for restoring a previously canceled subscription via a POST request to `/subscription/restore`. It requires an optional `referenceId` and the `subscriptionId` of the subscription to reactivate. This method only applies to subscriptions marked to cancel at the end of the period, not fully ended ones.

```ts
type restoreSubscription = {
    /**
     * Reference id of the subscription to restore. Defaults to the userId.
     */
    referenceId?: string = '123'
    /**
     * The id of the subscription to restore.
     */
    subscriptionId?: string = 'sub_123'
}
```

--------------------------------

### Define Subscription Database Table Schema (JSX)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/stripe.mdx

This snippet defines the declarative schema for the `subscription` database table using a JSX-like `DatabaseTable` component. It specifies field names, data types, descriptions, and properties such as primary key, uniqueness, optionality, and default values, outlining the structure for subscription-related data.

```jsx
<DatabaseTable
  fields={[
    {
      name: "id",
      type: "string",
      description: "Unique identifier for each subscription",
      isPrimaryKey: true
    },
    {
      name: "plan",
      type: "string",
      description: "The name of the subscription plan"
    },
    {
      name: "referenceId",
      type: "string",
      description: "The ID this subscription is associated with (user ID by default)",
      isUnique: true
    },
    {
      name: "stripeCustomerId",
      type: "string",
      description: "The Stripe customer ID",
      isOptional: true
    },
    {
      name: "stripeSubscriptionId",
      type: "string",
      description: "The Stripe subscription ID",
      isOptional: true
    },
    {
      name: "status",
      type: "string",
      description: "The status of the subscription (active, canceled, etc.)",
      defaultValue: "incomplete"
    },
    {
      name: "periodStart",
      type: "Date",
      description: "Start date of the current billing period",
      isOptional: true
    },
    {
      name: "periodEnd",
      type: "Date",
      description: "End date of the current billing period",
      isOptional: true
    },
    {
      name: "cancelAtPeriodEnd",
      type: "boolean",
      description: "Whether the subscription will be canceled at the end of the period",
      defaultValue: false,
      isOptional: true
    },
    {
      name: "seats",
      type: "number",
      description: "Number of seats for team plans",
      isOptional: true
    },
    {
      name: "trialStart",
      type: "Date",
      description: "Start date of the trial period",
      isOptional: true
    },
    {
      name: "trialEnd",
      type: "Date",
      description: "End date of the trial period",
      isOptional: true
    }
  ]}
/>
```

--------------------------------

### Handle Payments and Subscriptions with Autumn-js React

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/autumn.mdx

This snippet demonstrates how to use the `attach` function from `useCustomer` to redirect users to a Stripe checkout page for purchasing the Pro plan or confirm an existing payment method for a new subscription. It utilizes the `AttachDialog` component from `autumn-js/react`.

```tsx
import { useCustomer, AttachDialog } from "autumn-js/react";

export default function PurchaseButton() {
  const { attach } = useCustomer();

  return (
    <button
      onClick={async () => {
        await attach({
          productId: "pro",
          dialog: AttachDialog,
        });
      }}
    >
      Upgrade to Pro
    </button>
  );
}
```

--------------------------------

### Configure BetterAuth Database Hooks for User and Session Management

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/concepts/database.mdx

This TypeScript snippet demonstrates configuring `betterAuth` with `databaseHooks` for `user` (create, delete) and `session` (delete) entities. It showcases `before` hooks for data modification, validation, and logging, and `after` hooks for post-action processing like creating a Stripe customer or logging deletion completion.

```typescript
import { betterAuth } from "better-auth";

export const auth = betterAuth({
  databaseHooks: {
    user: {
      create: {
        before: async (user, ctx) => {
          // Modify the user object before it is created
          return {
            data: {
              // Ensure to return Better-Auth named fields, not the original field names in your database.
              ...user,
              firstName: user.name.split(" ")[0],
              lastName: user.name.split(" ")[1],
            },
          };
        },
        after: async (user) => {
          //perform additional actions, like creating a stripe customer
        },
      },
      delete: {
        before: async (user, ctx) => {
          console.log(`User ${user.email} is being deleted`);
          if (user.email.includes("admin")) {
            return false; // Abort deletion
          }

          return true; // Allow deletion
        },
        after: async (user) => {
          console.log(`User ${user.email} has been deleted`);
        },
      },
    },
    session: {
      delete: {
        before: async (session, ctx) => {
          console.log(`Session ${session.token} is being deleted`);
          if (session.userId === "admin-user-id") {
            return false; // Abort deletion
          }
          return true; // Allow deletion
        },
        after: async (session) => {
          console.log(`Session ${session.token} has been deleted`);
        },
      },
    },
  },
});
```

--------------------------------

### List customer subscriptions and payments (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/dodopayments.mdx

Examples for listing a customer's subscriptions and payment history via the client plugin. Inputs: query parameters like limit, page, and status; outputs: paginated lists returned under data. Handle possible errors from the returned error object.

```typescript
// Get subscriptions
const { data: subscriptions, error } =
  await authClient.dodopayments.customer.subscriptions.list({
    query: {
      limit: 10,
      page: 1,
      active: true,
    },
  });

// Get payment history
const { data: payments, error: paymentsError } = await authClient.dodopayments.customer.payments.list({
  query: {
    limit: 10,
    page: 1,
    status: "succeeded",
  },
});
```

--------------------------------

### List Customer Orders with Better-Auth Client

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/polar.mdx

This method lists orders, including purchases and subscription renewals, for the authenticated user or customer. It allows for pagination and filtering by product billing type (e.g., 'one_time' or 'recurring') using query parameters.

```typescript
const { data: orders } = await authClient.customer.orders.list({
  query: {
    page: 1,
    limit: 10,
    productBillingType: "one_time" // or 'recurring'
  }
});
```

--------------------------------

### POST /api/track

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/autumn.mdx

Track usage events for billing and feature limits

```APIDOC
## POST /api/track

### Description
Record customer usage events for billing and limit tracking

### Method
POST

### Endpoint
/api/track

### Parameters
#### Request Body
- **featureId** (string) - Required - The feature being used
- **value** (number) - Optional - Amount of usage to track (default: 1)
- **headers** (object) - Required - Request headers containing authentication

### Request Example
{
  "featureId": "messages",
  "value": 2
}

### Response
#### Success Response (200)
- **success** (boolean) - Confirmation of successful tracking
- **newBalance** (number) - Updated balance after tracking
```

--------------------------------

### List Customer Usage Meters (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/polar.mdx

Retrieves a paginated list of usage meters for the authenticated user, providing detailed information about their consumption, including consumed units, credited units, and balance for each defined meter.

```typescript
const { data: customerMeters } = await authClient.usage.meters.list({
  query: {
    page: 1,
    limit: 10,
  },
});
```

--------------------------------

### Initiate Checkout Session with Organization ID Reference

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/polar.mdx

This example extends the checkout initiation by including an `organizationId` as a `referenceId`. This allows tracking purchases made by organization members within the checkout, order, and subscription metadata.

```typescript
const organizationId = (await authClient.organization.list())?.data?.[0]?.id,

await authClient.checkout({
    // Any Polar Product ID can be passed here
    products: ["e651f46d-ac20-4f26-b769-ad088b123df2"],
    // Or, if you setup "products" in the Checkout Config, you can pass the slug
    slug: 'pro',
    // Reference ID will be saved as `referenceId` in the metadata of the checkout, order & subscription object
    referenceId: organizationId
});
```

--------------------------------

### Initiate LINE social sign-in with better-auth client (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/authentication/line.mdx

This code shows how to initiate a social sign-in flow using LINE as the provider via the 'better-auth/client' library. It calls the 'signIn.social' method with 'provider: "line"', which typically leads to a redirection to LINE's authentication page.

```ts
import { createAuthClient } from "better-auth/client";
const authClient = createAuthClient();

async function signInWithLINE() {
  const res = await authClient.signIn.social({ provider: "line" });
}
```

--------------------------------

### List Subscriptions for Authenticated User (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/polar.mdx

Fetches a paginated list of subscriptions for the currently authenticated user or customer, allowing filtering by active status.

```typescript
const { data: subscriptions } = await authClient.customer.subscriptions.list({
  query: {
    page: 1,
    limit: 10,
    active: true,
  },
});
```

--------------------------------

### Configure Usage Plugin for BetterAuth (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/polar.mdx

Demonstrates how to integrate the `usage` plugin, along with `checkout` and `portal`, into the Better Auth `polar` configuration for enabling usage-based billing features.

```typescript
import { polar, checkout, portal, usage } from "@polar-sh/better-auth";

const auth = betterAuth({
    // ... Better Auth config
    plugins: [
        polar({
            ...
            use: [
                checkout(...),
                portal(),
                usage()
            ],
        })
    ]
});
```

--------------------------------

### Create checkout session (TypeScript)

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/dodopayments.mdx

Demonstrates creating a checkout session via the client-side auth plugin. Inputs: product slug, customer info, billing address, and optional referenceId. Output: redirect to the returned checkout URL. Errors should be handled from the returned error variable.

```typescript
const { data: checkout, error } = await authClient.dodopayments.checkout({
  slug: "premium-plan",
  customer: {
    email: "customer@example.com",
    name: "John Doe",
  },
  billing: {
    city: "San Francisco",
    country: "US",
    state: "CA",
    street: "123 Market St",
    zipcode: "94103",
  },
  referenceId: "order_123",
});

if (checkout) {
  window.location.href = checkout.url;
}
```

--------------------------------

### GET /usage/meters

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/polar.mdx

Retrieves a paginated list of usage meters for the authenticated user. Customer meters contain comprehensive information about their consumption, credits, and balance.

```APIDOC
## GET /usage/meters

### Description
Retrieves a paginated list of usage meters for the authenticated user. Customer meters contain information about their consumption, credits, and balance.

### Method
GET

### Endpoint
/usage/meters

### Parameters
#### Query Parameters
- **page** (number) - Optional - The page number for pagination, default is 1.
- **limit** (number) - Optional - The maximum number of meters to return per page, default is 10.

### Request Example
N/A

### Response
#### Success Response (200)
- **data** (array) - An array of customer meter objects. Each object includes customer, meter, and consumption details.
- **page** (number) - The current page number.
- **limit** (number) - The limit of items per page.

#### Response Example
{
  "data": [
    {
      "customer": {
        "id": "cust_xyz"
      },
      "meter": {
        "id": "meter_uploads",
        "name": "File Uploads"
      },
      "consumedUnits": 120,
      "creditedUnits": 10,
      "balance": 110
    }
  ],
  "page": 1,
  "limit": 10
}
```

--------------------------------

### List Customer Benefits with Better-Auth Client

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/polar.mdx

This method lists granted benefits for the authenticated user or customer. It uses query parameters for pagination to retrieve a specific range of benefits from the Polar CustomerPortal API.

```typescript
const { data: benefits } = await authClient.customer.benefits.list({
  query: {
    page: 1,
    limit: 10
  }
});
```

--------------------------------

### Retrieve Customer State using Better-Auth Client

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/polar.mdx

This example shows how to fetch the general customer state using the Better-Auth client's `customer.state()` method. The returned object provides comprehensive data about the customer, including active subscriptions, benefits, and meter balances, useful for provisioning access.

```typescript
const { data: customerState } = await authClient.customer.state();
```

--------------------------------

### GET /customer/orders

Source: https://github.com/better-auth/better-auth/blob/canary/docs/content/docs/plugins/polar.mdx

Retrieves a paginated list of orders, which can include subscriptions, associated with a specific `referenceId` (e.g., an organization ID). This is useful for determining user access based on organizational subscriptions.

```APIDOC
## GET /customer/orders

### Description
Retrieves a paginated list of orders, which can include subscriptions, associated with a specific `referenceId` (e.g., an organization ID). This is useful for determining user access based on organizational subscriptions.

### Method
GET

### Endpoint
/customer/orders

### Parameters
#### Query Parameters
- **page** (number) - Optional - The page number for pagination, default is 1.
- **limit** (number) - Optional - The maximum number of orders to return per page, default is 10.
- **active** (boolean) - Optional - Filter orders by their active status.
- **referenceId** (string) - Required - The ID of the organization or reference entity to fetch orders for.

### Request Example
N/A

### Response
#### Success Response (200)
- **data** (array) - An array of order/subscription objects. Each object contains details about an order or subscription.
- **page** (number) - The current page number.
- **limit** (number) - The limit of items per page.

#### Response Example
{
  "data": [
    {
      "id": "order_org_456",
      "status": "paid",
      "productId": "prod_org_plan",
      "referenceId": "org_abc_id"
    }
  ],
  "page": 1,
  "limit": 10
}
```
